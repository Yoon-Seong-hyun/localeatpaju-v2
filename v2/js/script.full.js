
// Translation Data
const translations = {
     ko: {
          nav_home: "홈",
          nav_market: "마켓",
          nav_story: "브랜드 스토리",
          nav_farm: "농장체험",
          nav_camping: "별밤 캠핑",
          login: "로그인",
          signup: "회원가입",
          hero_subtitle: "Premium Local Food Market",
          hero_title: "파주의 시간이<br>맛이 되는 순간",
          hero_desc: "가장 가까운 거리에서 만나는 제철의 신선함.<br>오늘 아침, 농부의 손끝에서 당신의 식탁으로 전합니다.",
          btn_market: "마켓 입장하기",
          btn_story: "Brand Story",
          value_tag: "OUR VALUES",
          value_title: "왜 '로컬잇파주' 인가요?",
          value_desc: "단순히 농산물을 파는 것이 아닙니다. <br>우리는 자연과 사람, 그리고 식탁을 잇는 이야기를 전달합니다.",
          feat_1_title: "24시간 내 배송",
          feat_1_text: "\"오늘 아침에 딴 딸기를 저녁에 먹을 수 있다면?\"<br>파주 지역 내 100% 당일 수확, 당일 배송 원칙을 지킵니다. 유통과정이 길어지며 잃어버리는 맛과 영양을 지켜드립니다.",
          feat_1_link: "배송 정책 보기",
          feat_2_title: "투명한 농부 실명제",
          feat_2_text: "누가, 어디서, 어떻게 길렀는지 숨기지 않습니다. <br>모든 상품에는 농부님의 얼굴과 이름, 그리고 작물에 쏟은 정성이 기록된 '경작 일지' QR코드가 포함됩니다.",
          feat_3_title: "오감(五感) 체험",
          feat_3_text: "먹는 즐거움을 넘어 기르는 보람까지.<br>주말농장 분양과 계절별 수확 체험 프로그램을 통해, 아이들에게 흙을 만지는 소중한 추억을 선물하세요.",
          feat_3_link: "체험 예약하기",
          p_stat_tag: "SMART CHOICE",
          p_stat_price_title: "오늘의 가격,<br>투명하게 비교하세요.",
          p_stat_desc: "농림축산식품부와 aT(한국농수산식품유통공사)가 제공하는 <strong style='color: var(--color-primary);'>KAMIS</strong> 데이터를 실시간으로 확인하세요.<br><br>중간 유통 단계가 없는 로컬푸드가 얼마나 합리적인지, 직접 눈으로 확인하고 구매하세요. 농부에게는 제값을, 소비자에게는 만족을 드립니다.",
          p_stat_market: "일반 유통 단계",
          p_stat_local: "로컬잇파주",
          p_stat_zero: "0단계 (직거래)",
          loading_msg: "실시간 시세 정보를 불러오는 중...",
          curation_tag: "LIFESTYLE CURATION",
          curation_title: "DMZ가 제안하는<br>건강한 라이프스타일",
          curation_desc: "청정 자연의 에너지를 담은 로컬잇파주만의 특별한 제안.<br>당신의 하루를 더욱 가치있게 만들어 드립니다.",
          farmer_tag: "MONTHLY FARMER",
          farmer_title: "\"못생겨도 괜찮아,<br>약 안 치고 키웠잖아.\"",
          farmer_desc: "파주 문산읍에서 40년째 사과 농사를 짓고 계신 <b style='color: #333;'>김철수 농부님</b>.<br>올해 유난히 잦았던 비바람에도 꿋꿋이 버텨준 사과들이 기특하다고 하십니다. 모양은 조금 투박해도, 한 입 베어 물면 퍼지는 진한 과육의 향기는 그 어떤 백화점 과일과도 비교할 수 없습니다.",
          farmer_btn_interview: "인터뷰 전문 보기",
          farmer_btn_buy: "못난이 사과 구매하기",
          export_tag: "K-FOOD GLOBAL PROJECT",
          export_title: "파주의 맛, 세계의 식탁으로",
          export_desc: "장단콩을 활용한 <strong>두부 과자</strong>부터 파주 인삼 젤리까지.<br>로컬잇파주는 파주의 특산물을 가공하여 전 세계로 수출합니다.",
          export_desc: "장단콩을 활용한 <strong>두부 과자</strong>부터 파주 인삼 젤리까지.<br>로컬잇파주는 파주의 특산물을 가공하여 전 세계로 수출합니다.",
          export_btn: "수출 상품 보러가기",
          export_p1: "장단콩 두부과자",
          export_p1_desc: "미국/일본 수출",
          export_p2: "개성인삼 젤리스틱",
          export_p2_desc: "동남아 3국 수출",
          export_p3: "산머루 스파클링",
          export_p3_desc: "유럽 수출 예정",
          export_p4: "한수위 라이스칩",
          export_p4_desc: "비건 인증 완료",
          season_tag: "SEASONAL PICK",
          season_title: "지금 가장 맛있는",
          season_more_btn: "전체 상품 보기",
          review_title: "#로컬잇파주 후기",
          review_desc: "여러분의 식탁에 도착한 파주의 싱그러움을 공유해주세요.",
          footer_desc: "로컬잇파주는 파주시와 청년 농부들이 함께 만드는<br>로컬푸드 상생 프로젝트입니다.",
          footer_link_story: "브랜드 스토리",
          footer_link_terms: "이용약관",
          footer_link_privacy: "개인정보처리방침",
          footer_link_inquiry: "입점 문의",
          footer_info: "경기도 파주시 농부로 123 (가상건물) 1층 | 대표: 김파주<br>사업자등록번호: 000-00-00000 | 통신판매업신고: 2024-파주-0000<br>COPYRIGHT © 2024 LOCALeatPAJU. ALL RIGHTS RESERVED."
     },
     en: {
          nav_home: "Home",
          nav_market: "Market",
          nav_story: "Brand Story",
          nav_farm: "Experience",
          nav_camping: "Camping",
          login: "Log In",
          signup: "Sign Up",
          hero_subtitle: "Premium Local Food Market",
          hero_title: "Nature's Time<br>Becomes Flavor",
          hero_desc: "Freshness from the nearest distance.<br>Delivered from the farmer's hands to your table this morning.",
          btn_market: "Shop Now",
          btn_story: "Brand Story",
          value_tag: "OUR VALUES",
          value_title: "Why 'LocaleatPaju'?",
          value_desc: "Not just selling produce. <br>We deliver stories connecting nature, people, and your table.",
          feat_1_title: "24h Delivery",
          feat_1_text: "Picked this morning, on your table by dinner.<br>100% same-day harvest and delivery within Paju. We preserve the taste and nutrition often lost in long distribution processes.",
          feat_1_link: "View Policy",
          feat_2_title: "Transparent Farmer ID",
          feat_2_text: "We don't hide who, where, or how it was grown.<br>All products include a 'Farming Log' QR code with the farmer's face, name, and the care poured into the crops.",
          feat_3_title: "5-Senses Experience",
          feat_3_text: "Beyond eating, the joy of growing.<br>Offering weekend farm lots and seasonal harvest programs for cherished memories of touching the soil.",
          feat_3_link: "Book Experience",
          p_stat_tag: "SMART CHOICE",
          p_stat_price_title: "Today's Price,<br>Compare Transparently.",
          p_stat_desc: "Check real-time <strong style='color: var(--color-primary);'>KAMIS</strong> data provided by the Ministry of Agriculture and aT.<br><br>See how reasonable local food prices are without middlemen. Fair prices for farmers, satisfaction for consumers.",
          p_stat_market: "General Retail",
          p_stat_local: "LocaleatPaju",
          p_stat_zero: "Level 0 (Direct)",
          loading_msg: "Loading real-time price info...",
          curation_tag: "LIFESTYLE CURATION",
          curation_title: "Healthy Lifestyle<br>Suggested by DMZ",
          curation_desc: "Special proposals from LocaleatPaju containing the energy of clean nature.<br>We make your day more valuable.",
          farmer_tag: "MONTHLY FARMER",
          farmer_title: "\"It's okay to be ugly,<br>grown without pesticides.\"",
          farmer_desc: "Farmer <b style='color: #333;'>Cheol-su Kim</b>, engaging in apple farming for 40 years in Munsan-eup, Paju.<br>He says the apples that withstood this year's frequent rain and wind are commendable. Though a bit rough in shape, the deep flavor spreading in one bite is incomparable to any department store fruit.",
          farmer_btn_interview: "Read Interview",
          farmer_btn_buy: "Buy 'Ugly' Apples",
          export_tag: "K-FOOD GLOBAL PROJECT",
          export_title: "Taste of Paju, To the World",
          export_desc: "From <strong>Tofu Snacks</strong> using Jangdan Soybeans to Ginseng Jelly.<br>We export processed Paju specialties to the world.",
          export_desc: "From <strong>Tofu Snacks</strong> using Jangdan Soybeans to Ginseng Jelly.<br>We export processed Paju specialties to the world.",
          export_btn: "View Global Shop",
          export_p1: "Jangdan Tofu Snack",
          export_p1_desc: "Export to USA/JP",
          export_p2: "Ginseng Jelly Stick",
          export_p2_desc: "Export to SE Asia",
          export_p3: "Sanmeoru Sparkling",
          export_p3_desc: "Export to EU (Planned)",
          export_p4: "Hansuwi Rice Chip",
          export_p4_desc: "Vegan Certified",
          season_tag: "SEASONAL PICK",
          season_title: "Taliest Now",
          season_more_btn: "View All Products",
          review_title: "#LocaleatPaju Reviews",
          review_desc: "Share the freshness of Paju that arrived at your table.",
          footer_desc: "LocaleatPaju is a local food symbiosis project<br>created together by Paju City and young farmers.",
          footer_link_story: "Brand Story",
          footer_link_terms: "Terms of Service",
          footer_link_privacy: "Privacy Policy",
          footer_link_inquiry: "Partnership Inquiry",
          footer_info: "123 Farmer-ro, Paju-si, Gyeonggi-do (Virtual) 1F | CEO: Paju Kim<br>Business Reg: 000-00-00000 | E-commerce: 2024-Paju-0000<br>COPYRIGHT © 2024 LOCALeatPAJU. ALL RIGHTS RESERVED."
     },
     jp: {
          nav_home: "ホーム",
          nav_market: "マーケット",
          nav_story: "ブランド",
          nav_farm: "農場体験",
          nav_camping: "キャンプ",
          login: "ログイン",
          signup: "会員登録",
          hero_subtitle: "Premium Local Food Market",
          hero_title: "坡州(パジュ)の時間が<br>味になる瞬間",
          hero_desc: "最も近い距離で出会う旬の新鮮さ。<br>今朝、農家の手からあなたの食卓へお届けします。",
          btn_market: "マーケット入場",
          btn_story: "Brand Story",
          value_tag: "OUR VALUES",
          value_title: "なぜ 'LocaleatPaju'？",
          value_desc: "単に農産物を売るのではありません。<br>自然と人、そして食卓をつなぐ物語をお伝えします。",
          feat_1_title: "24時間以内配送",
          feat_1_text: "「今朝摘んだイチゴを夕食に？」<br>坡州地域内100％当日収穫、当日配送の原則を守ります。長い流通過程で失われる味と栄養を守ります。",
          feat_1_link: "配送ポリシーを見る",
          feat_2_title: "透明な農家実名制",
          feat_2_text: "誰が、どこで、どのように育てたか隠しません。<br>全商品に農家の顔と名前、そして作物に注いだ丹精が記録された「耕作日誌」QRコードが含まれます。",
          feat_3_title: "五感体験",
          feat_3_text: "食べる楽しさを超え、育てるやりがいまで。<br>週末農場分譲と季節ごとの収穫体験プログラムを通じて、子供たちに土に触れる大切な思い出をプレゼントしてください。",
          feat_3_link: "体験予約する",
          p_stat_tag: "SMART CHOICE",
          p_stat_price_title: "今日の価格、<br>透明に比較。",
          p_stat_desc: "農林畜産食品部とaTが提供する<strong style='color: var(--color-primary);'>KAMIS</strong>データをリアルタイムで確認してください。<br><br>中間流通のないローカルフードの合理的な価格を直接お確かめください。農家には正当な対価を、消費者には満足をお届けします。",
          p_stat_market: "一般流通",
          p_stat_local: "LocaleatPaju",
          p_stat_zero: "0段階 (直取引)",
          loading_msg: "リアルタイム相場情報を読み込み中...",
          curation_tag: "LIFESTYLE CURATION",
          curation_title: "DMZが提案する<br>健康的なライフスタイル",
          curation_desc: "清浄な自然のエネルギーを込めたLocaleatPajuだけの特別な提案。<br>あなたの一日をより価値あるものにします。",
          farmer_tag: "MONTHLY FARMER",
          farmer_title: "「不細工でも大丈夫、<br>薬を使わず育てたから。」",
          farmer_desc: "坡州汶山邑で40年間リンゴ農家を営む<b style='color: #333;'>キム・チョルスさん</b>。<br>今年の頻繁な雨風にも耐え抜いたリンゴたちが健気だと言います。形は少し不格好でも、一口かじれば広がる濃い果肉の香りは、どのデパートの果物とも比較できません。",
          farmer_btn_interview: "インタビュー全文",
          farmer_btn_buy: "不細工リンゴを購入",
          export_tag: "K-FOOD GLOBAL PROJECT",
          export_title: "坡州の味、世界の食卓へ",
          export_desc: "長湍豆を使った<strong>豆腐菓子</strong>から高麗人参ゼリーまで。<br>坡州の特産品を加工し、全世界へ輸出します。",
          export_desc: "長湍豆を使った<strong>豆腐菓子</strong>から高麗人参ゼリーまで。<br>坡州の特産品を加工し、全世界へ輸出します。",
          export_btn: "輸出商品を見る",
          export_p1: "長湍豆 豆腐菓子",
          export_p1_desc: "米国/日本 輸出",
          export_p2: "開城高麗人参ゼリー",
          export_p2_desc: "東南アジア輸出",
          export_p3: "山葡萄スパークリング",
          export_p3_desc: "欧州輸出予定",
          export_p4: "ハンスウィ ライスチップ",
          export_p4_desc: "ヴィーガン認証",
          season_tag: "SEASONAL PICK",
          season_title: "今一番美味しい",
          season_more_btn: "全商品を見る",
          review_title: "#LocaleatPaju レビュー",
          review_desc: "あなたの食卓に届いた坡州の瑞々しさを共有してください。",
          footer_desc: "LocaleatPajuは坡州市と青年農家が共に創る<br>ローカルフード共生プロジェクトです。",
          footer_link_story: "ブランドストーリー",
          footer_link_terms: "利用規約",
          footer_link_privacy: "個人情報処理方針",
          footer_link_inquiry: "入店のお問い合わせ",
          footer_info: "京畿道坡州市農夫路123（仮想ビル）1階 | 代表：キム・パジュ<br>事業者登録番号：000-00-00000 | 通信販売業申告：2024-坡州-0000<br>COPYRIGHT © 2024 LOCALeatPAJU. ALL RIGHTS RESERVED."
     },
     cn: {
          nav_home: "首页",
          nav_market: "市场",
          nav_story: "品牌故事",
          nav_farm: "农场体验",
          nav_camping: "露营",
          login: "登录",
          signup: "注册",
          hero_subtitle: "Premium Local Food Market",
          hero_title: "坡州的时间<br>化作美味的瞬间",
          hero_desc: "最近距离遇见的当季新鲜。<br>今天早上，从农夫手中直接送到您的餐桌。",
          btn_market: "进入市场",
          btn_story: "Brand Story",
          value_tag: "OUR VALUES",
          value_title: "为什么选择 'LocaleatPaju'？",
          value_desc: "不仅仅是销售农产品。<br>我们传递连接自然、人和餐桌的故事。",
          feat_1_title: "24小时内配送",
          feat_1_text: "“早上摘的草莓晚饭能吃到？”<br>坚持坡州地区内100%当日收获、当日配送原则。为您保留在漫长流通环节中流失的美味和营养。",
          feat_1_link: "查看配送政策",
          feat_2_title: "透明农户实名制",
          feat_2_text: "我们不隐瞒是谁、在哪里、如何种植的。<br>所有商品都包含记录了农户面孔、姓名以及对作物倾注心血的“耕作日志”二维码。",
          feat_3_title: "五感体验",
          feat_3_text: "超越吃的乐趣，感受种植的成就感。<br>通过周末农场认领和季节性收获体验项目，给孩子们礼物般珍贵的接触泥土的回忆。",
          feat_3_link: "预约体验",
          p_stat_tag: "SMART CHOICE",
          p_stat_price_title: "今日价格，<br>透明比较。",
          p_stat_desc: "实时查看农林畜产食品部和aT提供的<strong style='color: var(--color-primary);'>KAMIS</strong>数据。<br><br>请亲自确认没有中间流通的本地食品的合理价格。给农户合理的回报，给消费者满意的体验。",
          p_stat_market: "一般流通",
          p_stat_local: "LocaleatPaju",
          p_stat_zero: "0阶段 (直销)",
          loading_msg: "正在加载实时行情信息...",
          curation_tag: "LIFESTYLE CURATION",
          curation_title: "DMZ提案的<br>健康生活方式",
          curation_desc: "蕴含纯净自然能量的LocaleatPaju独家提案。<br>让您的一天更有价值。",
          farmer_tag: "MONTHLY FARMER",
          farmer_title: "“丑点没关系，<br>没打农药长大的。”",
          farmer_desc: "在坡州汶山邑从事苹果种植40年的<b style='color: #333;'>金哲秀老农</b>。<br>他说，今年的苹果在频繁的风雨中顽强生存下来，非常值得骄傲。虽然外形有点粗糙，但咬一口就能感受到的浓郁果肉香气，是任何百货商店的水果都无法比拟的。",
          farmer_btn_interview: "查看采访全文",
          farmer_btn_buy: "购买“丑”苹果",
          export_tag: "K-FOOD GLOBAL PROJECT",
          export_title: "坡州之味，走向世界",
          export_desc: "从使用长湍豆的<strong>豆腐饼干</strong>到人参果冻。<br>我们将坡州特产加工出口到全世界。",
          export_desc: "从使用长湍豆的<strong>豆腐饼干</strong>到人参果冻。<br>我们将坡州特产加工出口到全世界。",
          export_btn: "查看出口商品",
          export_p1: "长湍豆 豆腐饼干",
          export_p1_desc: "出口美国/日本",
          export_p2: "开城人参果冻棒",
          export_p2_desc: "出口东南亚",
          export_p3: "山葡萄气泡水",
          export_p3_desc: "预计出口欧洲",
          export_p4: "汉水大米脆片",
          export_p4_desc: "获得纯素认证",
          season_tag: "SEASONAL PICK",
          season_title: "现在最美味",
          season_more_btn: "查看全部商品",
          review_title: "#LocaleatPaju 评价",
          review_desc: "请分享送达您餐桌的坡州的清新。",
          footer_desc: "LocaleatPaju是坡州市和青年农户共同打造的<br>本地食品共生项目。",
          footer_link_story: "品牌故事",
          footer_link_terms: "使用条款",
          footer_link_privacy: "个人信息处理方针",
          footer_link_inquiry: "入驻咨询",
          footer_info: "京畿道坡州市农夫路123（虚拟建筑）1楼 | 代表：金坡州<br>营业执照号：000-00-00000 | 电商申报：2024-坡州-0000<br>COPYRIGHT © 2024 LOCALeatPAJU. ALL RIGHTS RESERVED."
     }
};

let currentLang = 'ko';

function changeLanguage(lang) {
     currentLang = lang;
     const t = translations[lang];

     // Apply translations to DOM elements with data-i18n attributes
     document.querySelectorAll('[data-i18n]').forEach(el => {
          const key = el.getAttribute('data-i18n');
          if (t[key]) {
               el.innerHTML = t[key];
          }
     });

     // Update dropdown label and active state
     const labels = { ko: 'KOREAN', en: 'ENGLISH', jp: 'JAPANESE', cn: 'CHINESE' };
     const labelEl = document.getElementById('current-lang-label');
     if (labelEl) labelEl.innerText = labels[lang];

     // Update active class in dropdown
     document.querySelectorAll('.lang-item').forEach(btn => {
          btn.classList.remove('active');
          if (btn.onclick.toString().includes(lang)) {
               btn.classList.add('active');
          }
     });
}

window.changeLanguage = changeLanguage;

// -----------------------------------------------------------
// 1. API & Data Logic (Consolidated for local preview)
// -----------------------------------------------------------

async function getProducts() {
     try {
          const response = await fetch('./data/products.json');
          if (!response.ok) throw new Error('Failed to fetch products');
          return await response.json();
     } catch (error) {
          console.warn('Local preview mode: Using fallback data for products');
          return [
               // --- A. Big Shots (대장주) ---
               {
                    "id": "p1",
                    "name": "파주 장단콩 (백태) 1kg",
                    "price": 18000,
                    "category": "PREMIUM BEAN",
                    "image": "assets/products/jangdan_soybean.png",
                    "badges": ["BEST", "A-CLASS"],
                    "description": "임금님 수라상에 올랐던 파주의 자랑. 배수가 좋은 마사토에서 자라 맛이 진하고 고소합니다.",
                    "trans": {
                         "en": { "name": "Paju Jangdan Soybeans 1kg", "description": "The pride of Paju, once served to the King. Grown in well-drained soil for a rich, nutty flavor." },
                         "jp": { "name": "坡州長湍豆 (白大豆) 1kg", "description": "王様の食卓に上がった坡州の誇り。水はけの良い土壌で育ち、味が濃く香ばしいです。" },
                         "cn": { "name": "坡州长湍豆 (白豆) 1kg", "description": "曾是进贡给国王的坡州骄傲。生长在排水良好的磨沙土中，味道浓郁香醇。" }
                    }
               },
               {
                    "id": "p5",
                    "name": "파주 개성인삼 6년근",
                    "price": 65000,
                    "category": "PREMIUM ROOT",
                    "image": "assets/products/paju_ginseng.png",
                    "badges": ["ENERGY"],
                    "description": "고려인삼의 맥을 잇는 6년근 파주 인삼. DMZ의 청정 자연이 키운 면역력의 결정체입니다.",
                    "trans": {
                         "en": { "name": "Paju Gaeseong Ginseng (6-year)", "description": "6-year-old Ginseng inheriting the legacy of Goryeo Ginseng. Grown in DMZ's nature." },
                         "jp": { "name": "坡州開城高麗人参 6年根", "description": "高麗人参の脈を受け継ぐ6年根。DMZの清浄な自然が育てた免疫力の結晶体です。" },
                         "cn": { "name": "坡州开城人参 6年根", "description": "继承高丽人参血脉的6年根。DMZ纯净自然孕育的免疫力结晶。" }
                    }
               },
               {
                    "id": "p6",
                    "name": "임진강 한수위 쌀 10kg",
                    "price": 42000,
                    "category": "PREMIUM RICE",
                    "image": "assets/products/hansuwi_rice.png",
                    "badges": ["DAILY"],
                    "description": "임진강의 맑은 물과 비옥한 토양이 키운 명품 쌀. 밥만 먹어도 달다는 말이 절로 나옵니다.",
                    "trans": {
                         "en": { "name": "Imjingang Hansuwi Rice 10kg", "description": "Premium rice grown with clear water from Imjin River. The rice itself tastes sweet." },
                         "jp": { "name": "臨津江ハンスウィ米 10kg", "description": "臨津江の清らかな水と肥沃な土壌が育てた名品米。ご飯だけで甘いと感じられます。" },
                         "cn": { "name": "临津江汉水大米 10kg", "description": "临津江清澈的江水和肥沃土壤孕育的名品大米。光吃饭也能感觉到甜味。" }
                    }
               },

               // --- B. Hidden Gems (숨은 보석) ---
               {
                    "id": "p7",
                    "name": "감악산 야생 칡즙 (30포)",
                    "price": 35000,
                    "category": "WILD NATURE",
                    "image": "assets/products/gamaksan_herbs.png",
                    "badges": ["WILD", "BEAUTY"],
                    "description": "사람의 손이 닿지 않은 감악산 야생 칡의 생명력. 숙취 해소와 이너뷰티를 위한 숲의 선물.",
                    "trans": {
                         "en": { "name": "Gamaksan Wild Arrowroot Extract", "description": "Wild vitality from Gamaksan untouched by human hands. A forest gift for inner beauty." },
                         "jp": { "name": "紺岳山野生葛汁 (30包)", "description": "人の手が届かない野生の生命力。二日酔い解消とインナービューティーのための森の贈り物。" },
                         "cn": { "name": "绀岳山野生葛根汁 (30包)", "description": "未经人手的绀岳山野生葛根的生命力。为解酒和内在美容准备的森林礼物。" }
                    }
               },
               {
                    "id": "p8",
                    "name": "파주 장단 마 (둥근마) 5kg",
                    "price": 48000,
                    "category": "ROOT VEG",
                    "image": "assets/products/jangdan_yam.png",
                    "badges": ["STOMACH CARE"],
                    "description": "임진강 모래흙이 키워 속이 꽉 찬 마. 위장을 보호하는 당신의 아침 친구입니다.",
                    "trans": {
                         "en": { "name": "Paju Jangdan Yam (Round) 5kg", "description": "Yam grown in Imjin River's sandy soil. A morning friend that protects your stomach." },
                         "jp": { "name": "坡州長湍長芋 (丸芋) 5kg", "description": "臨津江の砂土が育てた中身の詰まった長芋。胃腸を保護する朝の友達です。" },
                         "cn": { "name": "坡州长湍山药 (圆山药) 5kg", "description": "临津江沙土孕育的饱满山药。保护胃肠的早餐伴侣。" }
                    }
               },
               {
                    "id": "p3",
                    "name": "파주 산머루 와인 Premium",
                    "price": 32000,
                    "category": "LOCAL WINE",
                    "image": "assets/products/sanmeoru_wine.png",
                    "badges": ["GIFT"],
                    "description": "파주의 높은 일교차가 만든 달콤한 산머루로 빚은 와인. 감악산 터널 숙성으로 깊은 풍미를 자랑합니다.",
                    "trans": {
                         "en": { "name": "Paju Wild Grape Wine Premium", "description": "Sweet wild grape wine aged in Gamaksan tunnels. Boasts a deep flavor." },
                         "jp": { "name": "坡州山葡萄ワイン Premium", "description": "坡州の激しい寒暖差が作った甘い山葡萄ワイン。紺岳山トンネル熟成で深い風味が自慢です。" },
                         "cn": { "name": "坡州山葡萄红酒 Premium", "description": "由坡州巨大的昼夜温差造就的甜美山葡萄红酒。在绀岳山隧道熟成，风味深邃。" }
                    }
               },

               // --- C. Trendy Curations (틈새/가공) ---
               {
                    "id": "c1",
                    "name": "장단콩 비건 크림 롤케이크",
                    "price": 18500,
                    "category": "VEGAN DESSERT",
                    "image": "assets/products/tofu_snack.png",
                    "badges": ["VEGAN", "NO-GLU"],
                    "description": "[서울 추천] 우유 대신 고소한 장단콩 크림을 가득 채운 글루텐프리 디저트. 속 편한 달콤함.",
                    "trans": {
                         "en": { "name": "Jangdan Bean Vegan Cream Roll", "description": "Gluten-free dessert filled with nutty bean cream instead of milk. Comfortable sweetness." },
                         "jp": { "name": "長湍豆ヴィーガンクリームロール", "description": "牛乳の代わりに香ばしい長湍豆クリームを詰めたグルテンフリーデザート。" },
                         "cn": { "name": "长湍豆纯素奶油卷蛋糕", "description": "代替牛奶，填满香醇长湍豆奶油的无麸质甜点。舒适的甜蜜。" }
                    }
               },
               {
                    "id": "c2",
                    "name": "DMZ 모닝 쉐이크 (마+콩)",
                    "price": 29000,
                    "category": "MORNING ROUTINE",
                    "image": "assets/products/jangdan_yam.png",
                    "badges": ["DAILY"],
                    "description": "바쁜 아침, 위장을 감싸주는 DMZ 한 모금. 장단콩의 고소함이 마의 식감을 부드럽게 감싸줍니다.",
                    "trans": {
                         "en": { "name": "DMZ Morning Shake (Yam+Bean)", "description": "A sip of DMZ for your busy morning stomach. Nutty beans soften the texture of yam." },
                         "jp": { "name": "DMZモーニングシェイク (長芋+豆)", "description": "忙しい朝、胃腸を包み込むDMZの一口。長湍豆の香ばしさが長芋の食感を優しく包みます。" },
                         "cn": { "name": "DMZ 晨间奶昔 (山药+豆)", "description": "忙碌的早晨，保护胃肠的一口DMZ。长湍豆的香醇柔和了山药的口感。" }
                    }
               },
               {
                    "id": "c5",
                    "name": "애플 소이 약과 (Apple Soy)",
                    "price": 12000,
                    "category": "TRENDY SNACK",
                    "image": "assets/products/tofu_snack.png",
                    "badges": ["TRENDY"],
                    "description": "파주 사과 조청의 달콤함과 장단콩의 고소함이 만난 퓨전 약과. 할매니얼 입맛 저격!",
                    "trans": {
                         "en": { "name": "Apple Soy Yakgwa", "description": "Fusion Yakgwa meeting sweet Paju apple syrup and nutty beans. Perfect for K-dessert lovers!" },
                         "jp": { "name": "アップルソイ薬菓", "description": "坡州リンゴ水飴の甘さと長湍豆の香ばしさが出会ったフュージョン薬菓。" },
                         "cn": { "name": "苹果豆浆药果", "description": "坡州苹果糖稀的甜蜜与长湍豆的香醇相遇的融合药果。" }
                    }
               },

               // --- Experiences ---
               {
                    "id": "e1",
                    "name": "감자 캐기 & 팜크닉 (1인)",
                    "price": 25000,
                    "category": "EXPERIENCE",
                    "image": "assets/images/farm_experience.png",
                    "badges": ["FAMILY"],
                    "description": "파주의 흙을 만지고 수확의 기쁨을 느껴보세요. 유기농 쌈채소 점심이 포함됩니다.",
                    "trans": {
                         "en": { "name": "Potato Digging & Farmnic (1 Person)", "description": "Touch the soil of Paju and feel the joy of harvest. Organic vegetable lunch included." },
                         "jp": { "name": "ジャガイモ掘り & ファームニック (1人)", "description": "坡州の土に触れ、収穫の喜びを感じてください。オーガニック包み野菜の昼食が含まれます。" },
                         "cn": { "name": "挖土豆 & 农场野餐 (1人)", "description": "触摸坡州的泥土，感受收获的喜悦。包含有机生菜午餐。" }
                    }
               },
               {
                    "id": "e2",
                    "name": "별밤 글램핑 (1박)",
                    "price": 150000,
                    "category": "CAMPING",
                    "image": "assets/images/starlight_camping.png",
                    "badges": ["RESERVATION"],
                    "description": "쏟아지는 별빛 아래, 모닥불과 함께하는 낭만적인 하룻밤.",
                    "trans": {
                         "en": { "name": "Starlight Glamping (1 Night)", "description": "A romantic night with a campfire under the pouring starlight." },
                         "jp": { "name": "星月夜グランピング (1泊)", "description": "降り注ぐ星空の下、焚き火と共に過ごすロマンチックな一夜。" },
                         "cn": { "name": "星夜豪华露营 (1晚)", "description": "在倾泻的星光下，与篝火共度浪漫的一晚。" }
                    }
               }
          ];
     }
}

async function getMarketPrices() {
     // No delay for instant feedback
     return {
          date: new Date().toLocaleDateString('ko-KR'),
          items: [
               {
                    name: '딸기 (2kg)', marketPrice: 32000, localPrice: 25000, trend: 'up',
                    trans: {
                         en: "Strawberry (2kg)", jp: "イチゴ (2kg)", cn: "草莓 (2kg)"
                    }
               },
               {
                    name: '상추 (100g)', marketPrice: 1500, localPrice: 1200, trend: 'stable',
                    trans: {
                         en: "Lettuce (100g)", jp: "サンチュ (100g)", cn: "生菜 (100g)"
                    }
               },
               {
                    name: '방울토마토 (1kg)', marketPrice: 18000, localPrice: 15000, trend: 'down',
                    trans: {
                         en: "Cherry Tomato (1kg)", jp: "ミニトマト (1kg)", cn: "圣女果 (1kg)"
                    }
               },
               {
                    name: '고구마 (1kg)', marketPrice: 6500, localPrice: 5000, trend: 'up',
                    trans: {
                         en: "Sweet Potato (1kg)", jp: "サツマイモ (1kg)", cn: "红薯 (1kg)"
                    }
               }
          ]
     };
}

function formatPrice(price) {
     return new Intl.NumberFormat('ko-KR', { style: 'currency', currency: 'KRW' }).format(price);
}

// -----------------------------------------------------------
// 2. Components
// -----------------------------------------------------------

function initHeader() {
     const header = document.getElementById('main-header');
     if (header) {
          // window.addEventListener('scroll', () => {
          //      if (window.scrollY > 50) {
          //           header.classList.add('scrolled');
          //      } else {
          //           header.classList.remove('scrolled');
          //      }
          // });
     }
}

function renderProductCard(product) {
     const t = (product.trans && product.trans[currentLang]) || {};
     const name = t.name || product.name;
     const desc = t.description || product.description;

     const badgeHtml = product.badges && product.badges.length > 0
          ? `<div class="badge" style="position: absolute; top: 12px; left: 12px; background: var(--color-accent); color: white; padding: 4px 10px; font-size: 0.75rem; font-weight: 700; border-radius: 4px; z-index: 2;">${product.badges[0]}</div>`
          : '';

     return `
     <div class="product-card fade-in">
          <a href="#">
               <div class="product-img-wrap">
                    ${badgeHtml}
                    <img src="${product.image}" alt="${name}" class="product-img">
                         <div style="position: absolute; bottom:0; left:0; right:0; background: linear-gradient(to top, rgba(0,0,0,0.5), transparent); height: 50px;"></div>
               </div>
               <div class="product-info">
                    <span class="product-category">${product.category}</span>
                    <h3>${name}</h3>
                    <p style="font-size: 0.9rem; color: #888; margin-bottom: 8px; line-height: 1.4; min-height: 2.8em;">${desc ? desc.substring(0, 50) + '...' : ''}</p>
                    <div class="flex items-center justify-between">
                         <p style="color: var(--color-primary); font-weight: 700; font-size: 1.1rem; font-family:var(--font-main);">${formatPrice(product.price)}</p>
                         <span style="font-size: 1.2rem; color: var(--color-border);"><i class="fas fa-plus-circle"></i></span>
                    </div>
               </div>
          </a>
     </div>
     `;
}

function renderPriceWidget(data) {
     const trendLabels = {
          ko: { up: '상승세', down: '하락세', stable: '보합세', cheap: '저렴', avg: '평균가' },
          en: { up: 'Rising', down: 'Falling', stable: 'Stable', cheap: 'Cheaper', avg: 'Avg' },
          jp: { up: '上昇', down: '下落', stable: '横ばい', cheap: '安い', avg: '平均' },
          cn: { up: '上涨', down: '下跌', stable: '持平', cheap: '便宜', avg: '均价' }
     };
     const label = trendLabels[currentLang] || trendLabels.ko;

     const itemsHtml = data.items.map(item => {
          const tName = (item.trans && item.trans[currentLang]) || item.name;
          const saving = item.marketPrice - item.localPrice;
          const trendIcon = item.trend === 'up' ? 'text-red-500 fa-arrow-up' :
               item.trend === 'down' ? 'text-blue-500 fa-arrow-down' : 'text-gray-400 fa-minus';
          const iconColor = item.trend === 'up' ? '#ef4444' : item.trend === 'down' ? '#3b82f6' : '#9ca3af';
          const trendText = item.trend === 'up' ? label.up : item.trend === 'down' ? label.down : label.stable;

          return `
     <div class="price-item" style="border-bottom: 1px solid #eee; padding: 16px 0;">
            <div class="flex justify-between items-center mb-1">
                <span style="font-weight: 600; font-size: 1.05rem;">${tName}</span>
                <span style="font-size: 0.85rem; color: #888;">
                    <span style="color: var(--color-primary); font-weight: 700;">${Math.round((saving / item.marketPrice) * 100)}% ${label.cheap}</span>
                </span>
            </div>
            <div class="flex justify-between items-center">
                <div style="font-size: 0.9rem; color: #666;">
                    ${label.avg} <span style="text-decoration: line-through;">${formatPrice(item.marketPrice)}</span>
                </div>
                <div class="flex items-center gap-sm">
                    <span style="font-weight: 700; color: var(--color-text-main); font-size: 1.1rem;">
                        ${formatPrice(item.localPrice)}
                    </span>
                </div>
            </div>
            <div style="margin-top: 8px; font-size: 0.8rem; color: #999; display: flex; align-items: center; gap: 4px;">
                <i class="fas fa-chart-line" style="font-size: 0.7rem; color: ${iconColor}"></i> 
                <span>${trendText}</span>
            </div>
        </div>
     `;
     }).join('');

     // Use global translations object for widget header
     const t = translations[currentLang];
     const priceTitle = t.p_stat_price_title ? t.p_stat_price_title.replace('<br>', ' ') : '오늘의 시세';
     const priceDesc = t.p_stat_desc ? t.p_stat_desc.split('<br>')[0] : '중간 유통 마진을 뺀 로컬잇파주의 투명한 가격을 확인하세요.';

     return `
     <div class="price-widget-card" style="background: white; border-radius: 16px; padding: 32px; box-shadow: 0 10px 30px rgba(0,0,0,0.08);">
        <div style="margin-bottom: 24px; padding-bottom: 16px; border-bottom: 2px solid var(--color-text-main);">
            <div class="flex justify-between items-end">
                <h3 style="font-family: var(--font-serif); font-size: 1.5rem; margin: 0;">${priceTitle}</h3>
                <span style="font-size: 0.85rem; color: #666;">${data.date} (aT)</span>
            </div>
            <p style="font-size: 0.9rem; color: var(--color-text-sub); margin-top: 8px;">
                ${priceDesc}
            </p>
        </div>
        <div class="price-list">
            ${itemsHtml}
        </div>
        <div style="margin-top: 24px; text-align: center;">
            <a href="#" style="font-size: 0.85rem; color: var(--color-text-light); text-decoration: underline;">
                Data Source: KAMIS
            </a>
        </div>
    </div>
     `;
}

// -----------------------------------------------------------
// 3. Main Execution
// -----------------------------------------------------------

let globalProducts = [];
let globalMarketData = null;

async function fetchData() {
     try {
          const [products, marketData] = await Promise.all([
               getProducts(),
               getMarketPrices()
          ]);
          globalProducts = products;
          globalMarketData = marketData;
          renderApp();
     } catch (e) {
          console.error("Fetch error", e);
     }
}

function renderApp() {
     const productGrid = document.getElementById('product-grid');
     const priceWidgetContainer = document.getElementById('price-widget-container');

     // Render Products
     if (productGrid && globalProducts.length > 0) {
          productGrid.innerHTML = globalProducts.map(product => renderProductCard(product)).join('');
     }

     // Render Price Widget
     if (priceWidgetContainer && globalMarketData) {
          priceWidgetContainer.innerHTML = renderPriceWidget(globalMarketData);
     }
}

// Override the existing changeLanguage to include renderApp
window.changeLanguage = function (lang) {
     currentLang = lang;
     const t = translations[lang];

     // Apply translations to DOM elements with data-i18n attributes
     document.querySelectorAll('[data-i18n]').forEach(el => {
          const key = el.getAttribute('data-i18n');
          if (t[key]) {
               el.innerHTML = t[key];
          }
     });

     // Update dropdown label and active state
     const labels = { ko: 'KOREAN', en: 'ENGLISH', jp: 'JAPANESE', cn: 'CHINESE' };
     const labelEl = document.getElementById('current-lang-label');
     if (labelEl) labelEl.innerText = labels[lang];

     // Update active class in dropdown
     document.querySelectorAll('.lang-item').forEach(btn => {
          btn.classList.remove('active');
          if (btn.getAttribute('onclick') && btn.getAttribute('onclick').includes(lang)) {
               btn.classList.add('active');
          }
     });

     // Re-render dynamic content
     renderApp();
}

document.addEventListener('DOMContentLoaded', async () => {
     // 1. Header is now static in HTML for i18n
     initHeader();

     // Language Switcher Toggle
     const langWrapper = document.querySelector('.lang-dropdown-wrapper');
     const langBtn = document.querySelector('.lang-btn');

     if (langWrapper && langBtn) {
          langBtn.addEventListener('click', (e) => {
               e.stopPropagation();
               langWrapper.classList.toggle('active');
          });

          // Close on click outside
          document.addEventListener('click', () => {
               langWrapper.classList.remove('active');
          });
     }

     // Initial Fetch and Render
     await fetchData();
});
